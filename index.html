<!DOCTYPE html>
<html>
<head>
  <title>Markerless AR Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-xr@1.0.0/dist/aframe-xr.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #startButton {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px;
      background: white;
      border: none;
      cursor: pointer;
      z-index: 100;
    }
  </style>
</head>
<body>
  <button id="startButton">Start AR</button>
  <a-scene vr-mode-ui="enabled: false" embedded arjs>
    <a-assets>
      <a-asset-item id="cpu-model" src="cpu-model.glb"></a-asset-item>
    </a-assets>
    
    <!-- The invisible plane used to place the model -->
    <a-entity id="hit-test-container" visible="false">
      <a-entity id="hit-test" position="0 0 0"></a-entity>
    </a-entity>

    <!-- Model Entity -->
    <a-entity 
      gltf-model="#cpu-model" 
      scale="0.2 0.2 0.2" 
      position="0 0 -3" 
      visible="false"
      id="model">
    </a-entity>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const startButton = document.getElementById('startButton');
    const model = document.getElementById('model');
    const hitTestContainer = document.getElementById('hit-test-container');
    const hitTest = document.getElementById('hit-test');

    startButton.addEventListener('click', () => {
      document.querySelector('a-scene').enterVR();
    });

    AFRAME.registerComponent('ar-hit-test', {
      init: function () {
        const scene = this.el.sceneEl;
        let xrSession = null;
        let xrHitTestSource = null;
        
        this.el.sceneEl.addEventListener('enter-vr', async function () {
          xrSession = scene.renderer.xr.getSession();
          
          const viewerReferenceSpace = await xrSession.requestReferenceSpace('viewer');
          xrHitTestSource = await xrSession.requestHitTestSource({ space: viewerReferenceSpace });
          
          const frameOfReference = await xrSession.requestReferenceSpace('local');
          xrSession.requestAnimationFrame(function onXRFrame(time, frame) {
            let xrViewerPose = frame.getViewerPose(frameOfReference);
            if (xrViewerPose) {
              let hitTestResults = frame.getHitTestResults(xrHitTestSource);
              if (hitTestResults.length > 0) {
                let hit = hitTestResults[0];
                let pose = hit.getPose(frameOfReference);
                
                hitTestContainer.object3D.position.copy(pose.transform.position);
                hitTestContainer.object3D.visible = true;
                
                if (model.getAttribute('visible') === 'false') {
                  model.setAttribute('visible', 'true');
                }
                
                model.object3D.position.copy(pose.transform.position);
                model.object3D.quaternion.copy(pose.transform.orientation);
              }
            }
            xrSession.requestAnimationFrame(onXRFrame);
          });
        });

        this.el.sceneEl.addEventListener('exit-vr', function () {
          xrHitTestSource = null;
          xrSession = null;
          hitTestContainer.object3D.visible = false;
          model.setAttribute('visible', 'false');
        });
      }
    });

    document.querySelector('a-scene').setAttribute('ar-hit-test', '');
  </script>
</body>
</html>
